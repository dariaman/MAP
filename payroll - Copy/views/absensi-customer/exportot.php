<?phperror_reporting(E_ALL);ini_set('display_errors', TRUE);ini_set('display_startup_errors', TRUE);define('EOL',(PHP_SAPI == 'cli') ? PHP_EOL : '<br />');date_default_timezone_set('Asia/Jakarta');use \PHPExcel_IOFactory;use \yii\db\Command;$idjadwal = Yii::$app->request->get('idjadwal','xxx');$objReader = PHPExcel_IOFactory::createReader('Excel5');$objPHPExcel = $objReader->load("./files/Template Overtime.xls");$objPHPExcel->setActiveSheetIndex(0);$getJadwal = Yii::$app->db->createCommand("SELECT 	[jd].[IDJadwalAbsensiStatusH],	[jd].[SODID], 	[jd].[SeqProductID], 	[jd].[IsCloseAbsen], 	[jd].[CloseAbsenDate],	jh.AreaID,	jh.CustomerID,	jh.Thn,	jh.Bln FROM [JadwalAbsensiStatusD] [jd] 	LEFT JOIN [JadwalAbsensiStatusH] [jh] ON jh.IDJadwalAbsensiStatusH=jd.IDJadwalAbsensiStatusH WHERE [jh].[IDJadwalAbsensiStatusH] ='".$idjadwal."'")->queryAll();$countVal =  count($getJadwal);for($i = 0;$i < $countVal; $i++) {        //Get SO for generating data    $getSODID = Yii::$app->db->createCommand("        select glp.ProductID,glp.SeqProduct,glp.SODID,glp.AreaDetailDesc,glp.Status,glp.LicensePlate,mp.Nama        from GoLiveProduct glp                left join MasterProduct mp on mp.ProductID = glp.ProductID        where glp.sodid = '".$getJadwal[$i]['SODID']."'        and glp.ProductID is not null")->queryAll();        // Row start     $rowStart = 15;        //Get Data for Point and OT    $getDataMP = Yii::$app->db->createCommand("        select * from OTProductAmount otp            left join JadwalGolive jg on jg.SODID = otp.SODID and jg.SeqProduct = otp.SeqProduct            left join AbsensiCustomer ac on ac.SODID = otp.SODID and ac.SeqProduct = otp.SeqProduct and otp.tgl = ac.Tgl        where  otp.SODID  = '".$getSODID[$i]['SODID']."' and otp.SeqProduct = '".$getSODID[$i]['SeqProduct']."'")->queryAll();        //Get Active Sheet and Set title for Sheet    $clonedSheet[$i] = clone $objPHPExcel->getActiveSheet();    $clonedSheet[$i]->setTitle($getSODID[$i]['Nama']);        $clonedSheet[$i]->setCellValue('G2', $getSODID[$i]['Nama'])                    ->setCellValue('G3', $getSODID[$i]['LicensePlate'])            ;        // Loop for OT data    foreach($getDataMP as $j => $vals)    {           $row = $rowStart + $j;        $countData = count($getDataMP);        $rowTotal = $rowStart + $countData;        	$clonedSheet[$i]->insertNewRowBefore(($row+1),1);                $JadwalIn = $getDataMP[$j]['Monday1'];        $JadwalOut = $getDataMP[$j]['Monday2'];        $JamMasuk = date('H:i',strtotime($getDataMP[$j]['JamMasuk']));        $JamKeluar = date('H:i',strtotime($getDataMP[$j]['JamKeluar']));        $OTPagiJam = $getDataMP[$j]['TotalJamPagi'];        $OTPagiPoint = $getDataMP[$j]['TotalPointPagi'];        $OTMalamJam = $getDataMP[$j]['TotalJamMalam'];        $OTMalamPoint = $getDataMP[$j]['TotalPointMalam'];        $TotalPoint = $getDataMP[$j]['TotalPoint'];        $TotalAmount = $getDataMP[$j]['TotalAmount'];        	$clonedSheet[$i]->setCellValue('A'.$row, $j+1)                        ->setCellValue('B'.$row, date('j.M.o',strtotime($getDataMP[$j]['tgl'])))                        ->setCellValue('C'.$row, substr($JadwalIn,0,-3))                        ->setCellValue('D'.$row, substr($JadwalOut,0,-3))                        ->setCellValue('E'.$row, $JamMasuk)                        ->setCellValue('F'.$row, $JamKeluar)                        ->setCellValue('G'.$row, $OTPagiJam)                        ->setCellValue('H'.$row, $OTPagiPoint)                        ->setCellValue('I'.$row, $OTMalamJam)                        ->setCellValue('J'.$row, $OTMalamPoint)                        ->setCellValue('K'.$row, $TotalPoint)                        ->setCellValue('L'.$row, '=L2')                        ->setCellValue('M'.$row, $TotalAmount)                        ->setCellValue('Q'.$row, '=M'.$row.'+N'.$row.'+O'.$row.'+P'.$row);    }           // Remove row before    $clonedSheet[$i]->removeRow($rowStart-1,1);    $clonedSheet[$i]->removeRow($rowTotal-1,1);        // Total     $clonedSheet[$i]->setCellValue('G'.($rowTotal-1), '=SUM(G'.($rowStart-1).':G'.($row-1).')');    $clonedSheet[$i]->setCellValue('H'.($rowTotal-1), '=SUM(H'.($rowStart-1).':H'.($row-1).')');    $clonedSheet[$i]->setCellValue('I'.($rowTotal-1), '=SUM(I'.($rowStart-1).':I'.($row-1).')');    $clonedSheet[$i]->setCellValue('J'.($rowTotal-1), '=SUM(J'.($rowStart-1).':J'.($row-1).')');    $clonedSheet[$i]->setCellValue('K'.($rowTotal-1), '=SUM(K'.($rowStart-1).':K'.($row-1).')');    $clonedSheet[$i]->setCellValue('M'.($rowTotal-1), '=SUM(M'.($rowStart-1).':M'.($row-1).')');    $clonedSheet[$i]->setCellValue('Q'.($rowTotal-1), '=SUM(Q'.($rowStart-1).':Q'.($row-1).')');        //Get data for parameter lembur    $paramlembur = Yii::$app->db->createCommand("        select cc.BiayaID,cc.Amount,cc.Time,mb.Description        from SOD sd            left join CosCalc cc on cc.OfferingDID = sd.OfferingDID            left join MasterBiaya mb on mb.BiayaID = cc.BiayaID        where sd.SODID = '".$getSODID[$i]['SODID']."' and cc.BiayaID like 'LMB%'")->queryAll();    $countParamLembur = count($paramlembur);    $start = 2;    for($k = 0;$k < $countParamLembur;$k++)    {        $clonedSheet[$i]->setCellValue('N'.($start+$k), substr($paramlembur[$k]['Time'],0,-3))                            ->setCellValue('O'.($start+$k), $paramlembur[$k]['Amount'])                            ->setCellValue('P'.($start+$k), $paramlembur[$k]['Description'])            ;    }    //Get value/point    $valueperpoint = Yii::$app->db->createCommand("select Amount         from SOD sd        left join CosCalc cc on cc.OfferingDID = sd.OfferingDID        where SODID = '".$getSODID[$i]['SODID']."' and cc.BiayaID = 'GP000001'        ")->queryScalar();    $perpoint = ($valueperpoint/173);    $clonedSheet[$i]->setCellValue('L2', $perpoint);        // Add sheet to excel    $objPHPExcel->addSheet($clonedSheet[$i]);    }// Remove the first sheet index$objPHPExcel->removeSheetByIndex(0);header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="OTCustomer.xls"');header('Cache-Control: max-age=0');ob_end_clean();$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');$objWriter->save("php://output");