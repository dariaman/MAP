<?phperror_reporting(E_ALL);ini_set('display_errors', TRUE);ini_set('display_startup_errors', TRUE);define('EOL',(PHP_SAPI == 'cli') ? PHP_EOL : '<br />');date_default_timezone_set('Asia/Jakarta');use \PHPExcel_IOFactory as IO;use \yii\db\Command;$objReader = IO::createReader('Excel5');$objPHPExcel = $objReader->load("./files/Offering Template per Customer.xls");$objPHPExcel->setActiveSheetIndex(0);$Sheet1 = $objPHPExcel->getSheet(0);$Sheet2 = $objPHPExcel->getSheet(1);$sheet1row = '5';$sheet2row = '5';$lastColumnsheet1 = $Sheet1->getHighestColumn();$lastColumnsheet2 = $Sheet2->getHighestColumn();$lastColumnsheet1++;$lastColumnsheet2++;$styleBorder = array(    'borders' => array(      'allborders' => array(        'style' => PHPExcel_Style_Border::BORDER_THIN      )    ));$styleBorderDot = array(    'borders' => array(      'allborders' => array(        'style' => PHPExcel_Style_Border::BORDER_HAIR      )    ));$styleBold = array(    'font' => array(        'bold' => true    ));$styleItalic = array(    'font' => array(        'italic' => true    ));$fetchofh = Yii::$app->db->createCommand("select oh.NoSurat,oh.OfferingIDH,mc.CustomerName as CusName from OfferingH oh WITH(NOLOCK) left join MasterCustomer mc WITH(NOLOCK) on mc.CustomerID = oh.CustomerID where oh.OfferingIDH = '".$ofidh."'")->queryOne();$toarray = \yii\helpers\ArrayHelper::toArray($fetchofh);$fetchofd = Yii::$app->db->createCommand("select distinct ma.Description as AreaDesc,cc.OfferingDID from OfferingD od WITH(NOLOCK) left join OfferingH oh WITH(NOLOCK) on oh.OfferingIDH = od.OfferingIDHleft join MasterArea ma WITH(NOLOCK) on ma.AreaID = od.AreaIDleft join CosCalc cc WITH(NOLOCK) on cc.OfferingDID = od.OfferingDIDwhere od.OfferingIDH = '".$ofidh."' and cc.OfferingDID is not null and od.Class = 'A'")->queryAll();$fetchofdB = Yii::$app->db->createCommand("select distinct ma.Description as AreaDesc,cc.OfferingDID from OfferingD od WITH(NOLOCK) left join OfferingH oh WITH(NOLOCK) on oh.OfferingIDH = od.OfferingIDHleft join MasterArea ma WITH(NOLOCK) on ma.AreaID = od.AreaIDleft join CosCalc cc WITH(NOLOCK) on cc.OfferingDID = od.OfferingDIDwhere od.OfferingIDH = '".$ofidh."' and cc.OfferingDID is not null and od.Class = 'B'")->queryAll();$fetchjamsostek = Yii::$app->db->createCommand("select sum(cc.Amount) as Amt from CosCalc cc WITH(NOLOCK)left join OfferingD od WITH(NOLOCK) on od.OfferingDID = cc.OfferingDIDleft join OfferingH oh WITH(NOLOCK) on oh.OfferingIDH = od.OfferingIDHwhere cc.BiayaID IN ('BPJS0001','BPJS0002','BPJS0003','BPJS0004','BPJS0005')and oh.OfferingIDH = '".$ofidh."'")->queryScalar();$countfetch = count($fetchofd);$countfetchB = count($fetchofdB);$rowStart = 3;$rowEnd = 13;$row1Start = 16;$row1End = 28;//Sheet class A$Sheet1->setCellValue('B1',"Harga Sewa Jasa Pengemudi PT. Surya Sudeco Th. ".date('Y')." (Customer : ".$toarray['CusName'].")");$Sheet1->setCellValue('R4',$toarray['NoSurat']);foreach($fetchofd as $r => $dataRow) {        $colstart = 'C';    $coltime = 'B';    $colend = 'C';        for($i = 0;$i < $countfetch;$i++)    {        $colend++;    }        $gp = Yii::$app->db->createCommand("select Amount from CosCalc WITH(NOLOCK)    where offeringDid = '".$dataRow['OfferingDID']."' and biayaid = 'GP000001'")->queryScalar();        if($colstart != $colend)    {        $area = $Sheet1->setCellValue($colstart.$sheet1row,$dataRow['AreaDesc']);        $areamerge = $Sheet1->mergeCells($colstart.$sheet1row.":".$colstart.($sheet1row+1));                $gapok = $Sheet1->setCellValue($colstart.($sheet1row+3),$gp);                $fetchBiaya = Yii::$app->db->createCommand("select * from CosCalc cc WITH(NOLOCK) where cc.OfferingDID = '".$dataRow['OfferingDID']."'")->queryAll();        foreach($fetchBiaya as $r1 => $dataRow1)        {            $makan=0;            if($dataRow1['BiayaID'] == '00000001')            {                $makan = $dataRow1['Amount'];                continue;//            } else if($dataRow1['BiayaID'] == '0002')//            {//                $transport = $dataRow1['Amount'];//                continue;            }            $biayatrans = $Sheet1->setCellValue($colstart.($sheet1row+4),$makan);                        if($dataRow1['BiayaID'] == 'THR00001'){ $thramt = $dataRow1['Amount']; }            if($dataRow1['BiayaID'] == 'SRG00001'){ $srgamt = $dataRow1['Amount']; }            if($dataRow1['BiayaID'] == 'TRN00001'){ $trnamt = $dataRow1['Amount']; }            if($dataRow1['BiayaID'] == 'M1000001'){ $mgmfeeamt = $dataRow1['Amount']; }            if($dataRow1['BiayaID'] == 'M5000001'){ $mgmfeeotamt = $dataRow1['Amount']; }            if($dataRow1['BiayaID'] == 'LMB00001'){                $lmbrpagi = $dataRow1['Amount'];                $time1 = $dataRow1['Time'];            }                        if($dataRow1['BiayaID'] == 'LMB00002')            {                $lmbrmalam = $dataRow1['Amount'];                $time2 = $dataRow1['Time'];            }            if($dataRow1['BiayaID'] == 'LMB00003')            {                $lmbrtghmalam = $dataRow1['Amount'];                $time3 = $dataRow1['Time'];            }                        if($dataRow1['BiayaID'] == '00000013'){ $inapluar = $dataRow1['Amount']; }            if($dataRow1['BiayaID'] == '00000011'){ $instluar = $dataRow1['Amount']; }        }                        $insentifkhadiran = $Sheet1->setCellValue($colstart.($sheet1row+5),50000);        $jamsostek = $Sheet1->setCellValue($colstart.($sheet1row+6),'='.$colstart.($sheet1row+3)."*".$fetchjamsostek."%");                        $thr = $Sheet1->setCellValue($colstart.($sheet1row+7),$thramt);        $pesangon = $Sheet1->setCellValue($colstart.($sheet1row+8),'='.$colstart.($sheet1row+3)."/12");        $seragam = $Sheet1->setCellValue($colstart.($sheet1row+9),$srgamt);        $traning = $Sheet1->setCellValue($colstart.($sheet1row+10),$trnamt);//        $pph21 = $Sheet1->setCellValue($colstart.($sheet1row+11)//                ,'=+(((('.$colstart.($sheet1row+3).'+'.$colstart.($sheet1row+4).'+'.$colstart.($sheet1row+5).'+'//                .$colstart.($sheet1row+5).'+'.$colstart.($sheet1row+6).'+'.$colstart.($sheet1row+7).'+'.$colstart.($sheet1row+8).//                '+'.$colstart.($sheet1row+9).'+'.$colstart.($sheet1row+10).//                ')*12)-12000000)*5%)/12');        $subtotal = $Sheet1->setCellValue($colstart.($sheet1row+11),'=SUM('.$colstart.($sheet1row+3).":".$colstart.($sheet1row+10).')');        $mgmfee = $Sheet1->setCellValue($colstart.($sheet1row+12),'='.$colstart.($sheet1row+11)."*".$mgmfeeamt."%");        $total = $Sheet1->setCellValue($colstart.($sheet1row+13),'=SUM('.$colstart.($sheet1row+11).":".$colstart.($sheet1row+12).')');                $Sheet1->getStyle($colstart.$sheet1row.":".$colstart.($sheet1row+$rowEnd))->getNumberFormat()->setFormatCode('#,##0');        $Sheet1->getStyle($colstart.$sheet1row.":".$colstart.($sheet1row+$rowEnd))->applyFromArray($styleBorder);        $Sheet1->getStyle($colstart.($sheet1row+$rowEnd).":".$colstart.($sheet1row+$rowEnd))->applyFromArray($styleBold);                $area1 = $Sheet1->setCellValue($colstart.($sheet1row+$row1Start),$dataRow['AreaDesc']);        $areamerge1 = $Sheet1->mergeCells($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1Start+1));                $lmburhrkerja = $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+2),'=(('.$colstart.($sheet1row+3).'/173)*2)+(('.$colstart.($sheet1row+3).'/173)*2)*5%');        $pembulatan = $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+3),'=ROUNDUP('.$colstart.($sheet1row+$row1Start+2).',-2)');        $lmburhrjam = $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+4),'=(('.$colstart.($sheet1row+3).'/173)*3)+(('.$colstart.($sheet1row+3).'/173)*3)*5%');        $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+5),'=ROUNDUP('.$colstart.($sheet1row+$row1Start+4).',-2)');        $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+6),$instluar);        $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+7),100000);        $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+8),$inapluar);        $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+9),$lmbrpagi);        $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+10),$lmbrmalam);        $Sheet1->setCellValue($colstart.($sheet1row+$row1Start+11),$lmbrtghmalam);                $Sheet1->setCellValue($coltime.($sheet1row+$row1Start+9),"Tj. Kepagian (≤ ".substr($time1,0,5).")");        $Sheet1->setCellValue($coltime.($sheet1row+$row1Start+10),"Tj. Makan Lembur (≥ ".substr($time2,0,5).")");        $Sheet1->setCellValue($coltime.($sheet1row+$row1Start+11),"Tj. Kemalaman (≥ ".substr($time3,0,5).")");                $admfee = $Sheet1->setCellValue($colstart.($sheet1row+$row1End),$mgmfeeotamt.'%');        $admfeemerge = $Sheet1->mergeCells($colstart.($sheet1row+$row1End).":".$colstart.($sheet1row+$row1End+1));                //ROUNDUP(C24,-2)                        $Sheet1->getStyle($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1End))->getNumberFormat()->setFormatCode('#,##0');        $Sheet1->getStyle($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1Start+1))->applyFromArray($styleBorder);        $Sheet1->getStyle($colstart.($sheet1row+$row1Start+2).":".$colstart.($sheet1row+$row1End+1))->applyFromArray($styleBorderDot);        $Sheet1->getStyle($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1Start+2))->applyFromArray($styleItalic);        $Sheet1->getStyle($colstart.($sheet1row+$row1Start+4).":".$colstart.($sheet1row+$row1Start+4))->applyFromArray($styleItalic);        $Sheet1->getStyle($colstart.($sheet1row+$row1Start+3).":".$colstart.($sheet1row+$row1Start+3))->applyFromArray($styleBold);        $Sheet1->getStyle($colstart.($sheet1row+$row1Start+5).":".$colstart.($sheet1row+$row1End+1))->applyFromArray($styleBold);                $colstart++;    } else {        //$Sheet1->setCellValue($colstart.$sheet1row,'Same');            }//    die();}$Sheet2->setCellValue('B1',"Harga Sewa Jasa Pengemudi PT. Surya Sudeco Th. ".date('Y')." (Customer : ".$toarray['CusName'].")");$Sheet2->setCellValue('R4',$toarray['NoSurat']);foreach($fetchofdB as $r => $dataRow) {        $colstart = 'C';    $coltime = 'B';    $colend = 'C';        for($i = 0;$i < $countfetchB;$i++)    {        $colend++;    }        $gp = Yii::$app->db->createCommand("select Amount from CosCalc WITH(NOLOCK)    where offeringDid = '".$dataRow['OfferingDID']."' and biayaid = 'GP000001'")->queryScalar();        if($colstart != $colend)    {        $area = $Sheet2->setCellValue($colstart.$sheet1row,$dataRow['AreaDesc']);        $areamerge = $Sheet2->mergeCells($colstart.$sheet1row.":".$colstart.($sheet1row+1));                $gapok = $Sheet2->setCellValue($colstart.($sheet1row+3),$gp);                $fetchBiaya = Yii::$app->db->createCommand("select         * from CosCalc cc WITH(NOLOCK)        where cc.OfferingDID = '".$dataRow['OfferingDID']."'        ")->queryAll();                foreach($fetchBiaya as $r1 => $dataRow1)        {            $makan=0;            if($dataRow1['BiayaID'] == '00000001')            {                $makan = $dataRow1['Amount'];                continue;//            } else if($dataRow1['BiayaID'] == '0002')//            {//                $transport = $dataRow1['Amount'];//                continue;            }            $biayatrans = $Sheet2->setCellValue($colstart.($sheet1row+4),$makan);        }                        $insentifkhadiran = $Sheet2->setCellValue($colstart.($sheet1row+5),50000);        $jamsostek = $Sheet2->setCellValue($colstart.($sheet1row+6),'='.$colstart.($sheet1row+3)."*11.27%");        $thr = $Sheet2->setCellValue($colstart.($sheet1row+7),0);        $pesangon = $Sheet2->setCellValue($colstart.($sheet1row+8),'='.$colstart.($sheet1row+3)."/12");        $seragam = $Sheet2->setCellValue($colstart.($sheet1row+9),50000);        $traning = $Sheet2->setCellValue($colstart.($sheet1row+10),50000);//        $pph21 = $Sheet2->setCellValue($colstart.($sheet1row+11)//                ,'=+(((('.$colstart.($sheet1row+3).'+'.$colstart.($sheet1row+4).'+'.$colstart.($sheet1row+5).'+'//                .$colstart.($sheet1row+5).'+'.$colstart.($sheet1row+6).'+'.$colstart.($sheet1row+7).'+'.$colstart.($sheet1row+8).//                '+'.$colstart.($sheet1row+9).'+'.$colstart.($sheet1row+10).//                ')*12)-12000000)*5%)/12');        $subtotal = $Sheet2->setCellValue($colstart.($sheet1row+11),'=SUM('.$colstart.($sheet1row+3).":".$colstart.($sheet1row+10).')');        $mgmfee = $Sheet2->setCellValue($colstart.($sheet1row+12),'='.$colstart.($sheet1row+11)."*17.5%");        $total = $Sheet2->setCellValue($colstart.($sheet1row+13),'=SUM('.$colstart.($sheet1row+11).":".$colstart.($sheet1row+12).')');                $Sheet2->getStyle($colstart.$sheet1row.":".$colstart.($sheet1row+$rowEnd))->getNumberFormat()->setFormatCode('#,##0');        $Sheet2->getStyle($colstart.$sheet1row.":".$colstart.($sheet1row+$rowEnd))->applyFromArray($styleBorder);        $Sheet2->getStyle($colstart.($sheet1row+$rowEnd).":".$colstart.($sheet1row+$rowEnd))->applyFromArray($styleBold);                $area1 = $Sheet2->setCellValue($colstart.($sheet1row+$row1Start),$dataRow['AreaDesc']);        $areamerge1 = $Sheet2->mergeCells($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1Start+1));                $lmburhrkerja = $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+2),'=(('.$colstart.($sheet1row+3).'/173)*2)+(('.$colstart.($sheet1row+3).'/173)*2)*5%');        $pembulatan = $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+3),'=ROUNDUP('.$colstart.($sheet1row+$row1Start+2).',-2)');        $lmburhrjam = $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+4),'=(('.$colstart.($sheet1row+3).'/173)*3)+(('.$colstart.($sheet1row+3).'/173)*3)*5%');        $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+5),'=ROUNDUP('.$colstart.($sheet1row+$row1Start+4).',-2)');        $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+6),75000);        $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+7),100000);        $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+8),175000);        $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+9),10000);        $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+10),10000);        $Sheet2->setCellValue($colstart.($sheet1row+$row1Start+11),10000);                $admfee = $Sheet2->setCellValue($colstart.($sheet1row+$row1End),'5%');        $admfeemerge = $Sheet2->mergeCells($colstart.($sheet1row+$row1End).":".$colstart.($sheet1row+$row1End+1));                //ROUNDUP(C24,-2)                        $Sheet2->getStyle($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1End))->getNumberFormat()->setFormatCode('#,##0');        $Sheet2->getStyle($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1Start+1))->applyFromArray($styleBorder);        $Sheet2->getStyle($colstart.($sheet1row+$row1Start+2).":".$colstart.($sheet1row+$row1End+1))->applyFromArray($styleBorderDot);        $Sheet2->getStyle($colstart.($sheet1row+$row1Start).":".$colstart.($sheet1row+$row1Start+2))->applyFromArray($styleItalic);        $Sheet2->getStyle($colstart.($sheet1row+$row1Start+4).":".$colstart.($sheet1row+$row1Start+4))->applyFromArray($styleItalic);        $Sheet2->getStyle($colstart.($sheet1row+$row1Start+3).":".$colstart.($sheet1row+$row1Start+3))->applyFromArray($styleBold);        $Sheet2->getStyle($colstart.($sheet1row+$row1Start+5).":".$colstart.($sheet1row+$row1End+1))->applyFromArray($styleBold);                $colstart++;    } else {        //$Sheet2->setCellValue($colstart.$sheet1row,'Same');            }//    die();}    unset($styleBorder);    unset($styleBold);header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="OfferingCustomer.xls"');header('Cache-Control: max-age=0');ob_end_clean();$objWriter = IO::createWriter($objPHPExcel, 'Excel5');$objWriter->save("php://output");