<?phperror_reporting(E_ALL);ini_set('display_errors', TRUE);ini_set('display_startup_errors', TRUE);define('EOL',(PHP_SAPI == 'cli') ? PHP_EOL : '<br />');date_default_timezone_set('Asia/Jakarta');use \PHPExcel_IOFactory as IO;use yii\db\Command;//print_r($value);//die();$objReader = IO::createReader('Excel5');$objPHPExcel = $objReader->load("./files/Cost Calc Detail.xls");//$objPHPExcel = $objReader->load("./files/Book1.xls");$objPHPExcel->getActiveSheet()->setCellValue('C3', date('d-m-Y'));$getmfee = Yii::$app->db->createCommand("select Amount from CosCalc where BiayaID='M1000001' and OfferingDID = '".$_GET['ofd']."'")->queryScalar();$FixRow = 11;$Fix = "select     mb.Description as BiayaName ,     cc.Amount as Amount,     cc.Remark as Remark ,    ma.Description as AreaName,     od.Class,    mj.Description as JobDesc,    oh.NoSuratfrom CosCalc cc WITH(NOLOCK)left join OfferingD od WITH(NOLOCK) on od.OfferingDID = cc.OfferingDIDleft join OfferingH oh WITH(NOLOCK) on oh.OfferingIDH = od.OfferingIDHleft join MasterBiaya mb WITH(NOLOCK) on mb.BiayaID = cc.BiayaIDleft join MasterArea ma WITH(NOLOCK) on ma.AreaID = od.AreaIDleft join MasterJobDesc mj WITH(NOLOCK) on mj.IDJobDesc = oh.IDJobDescwhere cc.OfferingDID = '".$_GET['ofd']."' and mb.TipeBiaya = '1FX'";$valueFix = Yii::$app->db->createCommand($Fix)->queryAll();$TmbRow = $FixRow + count($valueFix) + 2;$Tmb = "select     mb.Description as BiayaName ,     cc.Amount as Amount,     cc.Remark as Remark ,    mb.BiayaID as BiayaIDfrom CosCalc cc WITH(NOLOCK)left join OfferingD od WITH(NOLOCK) on od.OfferingDID = cc.OfferingDIDleft join MasterBiaya mb WITH(NOLOCK) on mb.BiayaID = cc.BiayaIDwhere mb.TipeBiaya IN ('2TMB','BPJS') and cc.OfferingDID = '".$_GET['ofd']."'";$valueTmb = Yii::$app->db->createCommand($Tmb)->queryAll();$mgmfee = "select sum(Amount) as TotalMgmFee from CosCalc WITH(NOLOCK)where offeringdid = '".$_GET['ofd']."'and IsManagementFee = 1 and LEFT(BiayaID,4) <> 'BPJS'";$valuemgmfee = Yii::$app->db->createCommand($mgmfee)->queryScalar();$mgmfeebpjs = "DECLARE @ump DECIMAL(18,2)SET @ump = (SELECT mgp.UMP FROM OfferingD odLEFT JOIN dbo.OfferingH oh ON oh.OfferingIDH = od.OfferingIDHLEFT JOIN dbo.MasterGajiPokok mgp ON mgp.AreaID = od.AreaID AND mgp.IDJobDesc = oh.IDJobDescWHERE offeringdid = '".$_GET['ofd']."')SELECT ISNULL(sum(((Amount*@ump)/100)),0) AS Amount FROM dbo.CosCalc WHERE BiayaID IN (SELECT BiayaID FROM dbo.CosCalc WHERE LEFT(BiayaID,4) = 'BPJS')AND OfferingDID = '".$_GET['ofd']."' and IsManagementFee = '1'";$valmgmfeebpjs = Yii::$app->db->createCommand($mgmfeebpjs)->queryScalar();$sumfix = $FixRow+count($valueFix);$sumtmb = $TmbRow+count($valueTmb);$mfeeprcntge = floatval($getmfee);$gapok = "select Amount from CosCalc cc WITH(NOLOCK)left join OfferingD od WITH(NOLOCK) on od.OfferingDID = cc.OfferingDIDwhere od.OfferingDID = '".$_GET['ofd']."' and cc.BiayaID = 'GP000001'";$valuegapok = Yii::$app->db->createCommand($gapok)->queryScalar();$ump = "select Amount from CosCalc cc WITH(NOLOCK)left join OfferingD od WITH(NOLOCK) on od.OfferingDID = cc.OfferingDIDwhere od.OfferingDID = '".$_GET['ofd']."' and cc.BiayaID = 'UMP00001'";$valueump = Yii::$app->db->createCommand($gapok)->queryScalar();$nonfix = "select     mb.Description as BiayaName ,     cc.Amount as Amount,     cc.Remark as Remark      from CosCalc cc WITH(NOLOCK)left join masterbiaya mb WITH(NOLOCK) on mb.BiayaID = cc.BiayaIDwhere offeringdid = '".$_GET['ofd']."' and TipeBiaya IN ('3NFIX','LMB','MGM2')order by mb.SeqNo";$valueNfix = Yii::$app->db->createCommand($nonfix)->queryAll();$NfixRow = ($sumtmb + $sumfix) - 8;$objPHPExcel->getActiveSheet()->setCellValue('A9', 1)	                              ->setCellValue('B9', 'Gaji Pokok')	                              ->setCellValue('D9', $valuegapok)	                              ->setCellValue('E9' ,'Gaji Pokok');$objPHPExcel->getActiveSheet()->setCellValue('C5', $valueFix[0]['AreaName']);$objPHPExcel->getActiveSheet()->setCellValue('C2', $valueFix[0]['NoSurat']);$objPHPExcel->getActiveSheet()->setCellValue('A1', "Lampiran detail harga driver tahun ".date('Y'));$objPHPExcel->getActiveSheet()->setCellValue('A6', ucfirst(strtolower($valueFix[0]['JobDesc'])).' kelas '.$valueFix[0]['Class']);foreach($valueFix as $r => $dataRow) {//    print_r($dataRow['Amount']);//    die();	$row = $FixRow + $r;	$objPHPExcel->getActiveSheet()->insertNewRowBefore($row,1);	$objPHPExcel->getActiveSheet()->setCellValue('A'.$row, $r+2)	                              ->setCellValue('B'.$row, $dataRow['BiayaName'])	                              ->setCellValue('D'.$row, $dataRow['Amount'])	                              ->setCellValue('E'.$row, $dataRow['Remark']);	                              //->setCellValue('F'.$row, '=C'.$row.'*D'.$row);}$objPHPExcel->getActiveSheet()->removeRow($FixRow-1,1);$objPHPExcel->getActiveSheet()->setCellValue('D'.($FixRow+count($valueFix)-1), '=SUM(D'.($FixRow-2).':D'.($sumfix-2).')');foreach($valueTmb as $r => $dataRow) {//    print_r($dataRow['Amount']);//    die();	$row = $TmbRow + $r;	$objPHPExcel->getActiveSheet()->insertNewRowBefore($row,1);	$objPHPExcel->getActiveSheet()->setCellValue('A'.$row, $r+1);	$objPHPExcel->getActiveSheet()->setCellValue('B'.$row, $dataRow['BiayaName']);                if(substr($dataRow['BiayaID'],0,4) == 'BPJS')        {            $objPHPExcel->getActiveSheet()->setCellValue('D'.$row, ($valueump*$dataRow['Amount'])/100)->getStyle('D'.$row)->getNumberFormat()->setFormatCode(PHPExcel_Style_NumberFormat::FORMAT_NUMBER_COMMA_SEPARATED1);        } else {            $objPHPExcel->getActiveSheet()->setCellValue('D'.$row, $dataRow['Amount']);        }		$objPHPExcel->getActiveSheet()->setCellValue('E'.$row, $dataRow['Remark'])->getColumnDimension('E')->setAutoSize(true);//        $objPHPExcel->getActiveSheet()->setCellValue('F'.$row, '=C'.$row.'*D'.$row);}$objPHPExcel->getActiveSheet()->removeRow($TmbRow-1,1);$objPHPExcel->getActiveSheet()->setCellValue('D'.($sumtmb-1), '=SUM(D'.($TmbRow-1).':D'.($sumtmb-2).')');$totaldpphpp = $objPHPExcel->getActiveSheet()->setCellValue('D'.($sumtmb), '=D'.($FixRow+count($valueFix)-1).'+D'.($sumtmb-1).')');$mfee = $objPHPExcel->getActiveSheet()->setCellValue('D'.($sumtmb+1), '='.($valuemgmfee+$valmgmfeebpjs).'*'.$mfeeprcntge.'%');$mfeedesc = $objPHPExcel->getActiveSheet()->setCellValue('E'.($sumtmb+1), $valueTmb[0]['Remark'] );foreach($valueNfix as $r => $dataRow) {//    print_r($dataRow['Amount']);//    die();	$row = $NfixRow + $r;	$objPHPExcel->getActiveSheet()->insertNewRowBefore($row,1);	$objPHPExcel->getActiveSheet()->setCellValue('A'.$row, $r+1)	                              ->setCellValue('B'.$row, $dataRow['BiayaName'])	                              ->setCellValue('D'.$row, $dataRow['Amount'])	                              ->setCellValue('E'.$row, $dataRow['Remark']);	                              //->setCellValue('F'.$row, '=C'.$row.'*D'.$row);}$objPHPExcel->getActiveSheet()->removeRow($NfixRow-1,1);$objPHPExcel->getActiveSheet()->setTitle('Harga '.ucfirst($valueFix[0]['AreaName']).' Kelas '.$valueFix[0]['Class']);header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="CostCalc.xls"');header('Cache-Control: max-age=0');ob_end_clean();$objWriter = IO::createWriter($objPHPExcel, 'Excel5');$objWriter->save("php://output");