<?phperror_reporting(E_ALL);ini_set('display_errors', TRUE);ini_set('display_startup_errors', TRUE);define('EOL',(PHP_SAPI == 'cli') ? PHP_EOL : '<br />');date_default_timezone_set('Asia/Jakarta');use \PHPExcel_IOFactory;use \yii\db\Command;$objReader = PHPExcel_IOFactory::createReader('Excel5');$objPHPExcel = $objReader->load("./files/Template Invoice.xls");$objPHPExcel->setActiveSheetIndex(0);$getBilling = Yii::$app->db->createCommand("    select mc.CustomerName as CusName,* from Invoice inv    left join MasterCustomer mc on mc.CustomerID = inv.CustomerID")->queryAll();$countInv = count($getBilling);for($i=0;$i<$countInv;$i++){        $getInfo =  Yii::$app->db->createCommand("        SELECT *         FROM BillingH bh        left join Invoice inv on inv.InvoiceNo = bh.InvoiceNo        where bh.InvoiceNo ='".$getBilling[$i]['InvoiceNo']."'        order by TipeBilling")->queryAll();        $clonedSheet[$i] = clone $objPHPExcel->getActiveSheet();    $clonedSheet[$i]->setTitle($getBilling[$i]['InvoiceNo']);           $Date = $getBilling[$i]['InvoiceDate'];    $TOPDate = date('j M Y', strtotime($Date. ' + 14 days'));    //Customer    $clonedSheet[$i]->setCellValue('A6', $getBilling[$i]['CusName']);    $clonedSheet[$i]->setCellValue('A8', $getBilling[$i]['Address']);        //Invoice    $clonedSheet[$i]->setCellValue('I4', $getBilling[$i]['InvoiceNo']);    $clonedSheet[$i]->setCellValue('I6', $TOPDate);    $rowStart = 10;    $countrow = count($getInfo);        foreach($getInfo as $index => $values)    {                $row = $rowStart + $index;	$clonedSheet[$i]->insertNewRowBefore(($row+1),1);        //Keterangan        $clonedSheet[$i]->setCellValue('A'.$row,'Total DPP Billing '.$getInfo[$index]['TipeBilling'].' PERIODE '.substr($getInfo[$index]['Periode'],4,5)." ".substr($getInfo[$index]['Periode'],0,4));        $clonedSheet[$i]->setCellValue('G'.$row,'Rp.');                //Jumlah        $clonedSheet[$i]->setCellValue('I'.$row,$getInfo[$index]['TotalDPP']);            }    $clonedSheet[$i]->removeRow(($rowStart-1),1);            //Total    $clonedSheet[$i]->setCellValue('I'.($countrow+$rowStart),$getBilling[$i]['TotalMFee']);    $clonedSheet[$i]->setCellValue('I'.($countrow+$rowStart+1),$getBilling[$i]['TotalPPN']);    $clonedSheet[$i]->setCellValue('I'.($countrow+$rowStart+5),$getBilling[$i]['TotalInvoice']);        $terbilang = Yii::$app->db->createCommand("select dbo.fnEPKonversiBilanganDecimal(".round($getBilling[$i]['TotalInvoice'], 0, PHP_ROUND_HALF_EVEN).")")->queryScalar();        //Terbilang    $clonedSheet[$i]->setCellValue('B18',$terbilang);        $InvDate = date('j M Y', strtotime($Date));        //Tanggal Cetak    $clonedSheet[$i]->setCellValue('I20','Jakarta,'.$InvDate);        // Add sheet to excel    $objPHPExcel->addSheet($clonedSheet[$i]);}$objPHPExcel->removeSheetByIndex(0);// Add a drawing to the worksheet//echo date('H:i:s') , " Add a drawing to the worksheet" , EOL;//$objDrawing = new PHPExcel_Worksheet_Drawing();//$objDrawing->setName('Logo');//$objDrawing->setDescription('Logo');//$objDrawing->setPath('./images/officelogo.jpg');//$objDrawing->setHeight(36);//$objDrawing->setWorksheet($objPHPExcel->getActiveSheet());header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="InvoiceBilling.xls"');header('Cache-Control: max-age=0');ob_end_clean();$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');$objWriter->save("php://output");